AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Resources:
  SecureLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /var/log/secure
      RetentionInDays: 90
 
  SSHAcceptedAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AcceptedSSHLoginTopic
      AlarmDescription: Alert Accepted SSH Login
      AlarmName: Alert-Accepted-SSH-Login
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: Accepted-SSH-Login
      Namespace: EC2Bastion
      Period: 60
      Statistic: Average
      Threshold: 1

  AcceptedSSHLoginMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: Accepted
      LogGroupName: !Ref SecureLogGroup
      MetricTransformations:
        - DefaultValue: 0
          MetricName: Accepted-SSH-Login
          MetricNamespace: EC2Bastion
          MetricValue: 1

  AcceptedSSHLoginTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: false
      FifoTopic: false
      KmsMasterKeyId: false
      Subscription:
        - Endpoint: ito@gizumo-inc.jp
          Protocol: email
      Tags:
        - Key: Name
          Value: AcceptedSSHLoginAlert
      TopicName: Accepted-SSH-Login

