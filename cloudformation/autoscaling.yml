AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parameters:
  Env:
    Type: String
    Default: test
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: The EC2 Key Pair to allow SSH access to the instance
  EC2InstanceType:
    Type: String
    Default: t2.micro 
    AllowedValues: [t2.micro, t3.micro]
    Description: Enter t2.micro or t3.micro
  EC2AMIID:
    Type: String
    Default: ami-032d6db78f84e8bf5

Resources:
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: EC2AutoScalingGroup
      AvailabilityZones:
        - !Select
          - 0
          - Fn::GetAZs: !Ref AWS::Region
        - !Select
          - 1
          - Fn::GetAZs: !Ref AWS::Region
      Cooldown: 300
      DesiredCapacityType: units
      DesiredCapacity: 1
      MinSize: 1
      MaxSize: 1
      HealthCheckType: EC2
      HealthCheckGracePeriod: 120
      LaunchTemplate:
        LaunchTemplateId: !Ref EC2LaunchTemplate
        Version: !GetAtt EC2LaunchTemplate.LatestVersionNumber
      LifecycleHookSpecificationList:
        - DefaultResult: ABANDON
          HeartbeatTimeout: 120
          LifecycleHookName: EC2LifecycleHook
          LifecycleTransition: EC2_INSTANCE_LAUNCHING
      MaxInstanceLifetime: 0
      MetricsCollection:
        - Granularity: 1Minute
          Metrics:
            - GroupInServiceInstances
            - GroupPendingInstances
            - GroupStandbyInstances
            - GroupTotalInstances
      NewInstancesProtectedFromScaleIn: false
      TargetGroupARNs:
        - Fn::ImportValue:
            !Sub ${Env}-ALBTargetGroup
      TerminationPolicies:
        - OldestInstance
      VPCZoneIdentifier:
        - Fn::ImportValue:
            !Sub ${Env}-PublicSubnet1a
        - Fn::ImportValue:
            !Sub ${Env}-PublicSubnet1c
      Tags:
        - Key: Name
          Value: !Sub ${Env}-ec2
          PropagateAtLaunch: true

