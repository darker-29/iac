AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parameters:
  Name:
    Type: String
    Default: nobody
    Description: 'Enter Your Name. (Exam: d-ito)'
  KeyName:
    Description: The EC2 Key Pair to allow SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName

Resources:
  EC2InstanceRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      Path: "/"

  EnableAccessS3Policy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: EC2AccessPolicies
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: "s3:*"
          Resource:
            - "arn:aws:s3:::*"
      Roles:
      - !Ref EC2InstanceRole

  EnableAccessCloudWatchPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: EC2AccessPolicies
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: "cloudwatch:*"
          Resource:
            - "arn:aws:cloudwatch:::*"
      Roles:
      - !Ref EC2InstanceRole

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: EC2InstanceProfile
      Roles:
        - !Ref EC2InstanceRole

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-032d6db78f84e8bf5
      KeyName: !Ref KeyName
      InstanceType: t2.micro
      EC2InstanceProfile: !Ref EC2InstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !ImportValue PublicSubnet
          GroupSet:
            - !ImportValue WebSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            DeleteOnTermination: true
            Encrypted: false
            VolumeSize: 8
            VolumeType: gp2
      UserData: !Base64 |
        #!/bin/bash
        sudo yum install -y git amazon-cloudwatch-agent
      Tags:
        - Key: Name
          Value: ec2-tmp

  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData: # Optional
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              DeleteOnTermination: true
              Encrypted: true
              VolumeSize: 8
              VolumeType: gp2
        CapacityReservationSpecification: # Optional
          CapacityReservationPreference: CHANGEME # Optional
          CapacityReservationTarget: # Optional
            CapacityReservationId: CHANGEME # Optional
            CapacityReservationResourceGroupArn: CHANGEME # Optional
        CpuOptions: # Optional
          CoreCount: 0 # Optional
          ThreadsPerCore: 0 # Optional
        CreditSpecification: # Optional
          CpuCredits: CHANGEME # Optional
        DisableApiTermination: false # Optional
        EbsOptimized: false # Optional
        ElasticGpuSpecifications: # Optional
          - Type: CHANGEME # Optional
        ElasticInferenceAccelerators: # Optional
          - Count: 0 # Optional
            Type: CHANGEME # Optional
        EnclaveOptions: # Optional
          Enabled: false # Optional
        HibernationOptions: # Optional
          Configured: false # Optional
        IamInstanceProfile: # Optional
          Arn: CHANGEME # Optional
          Name: CHANGEME # Optional
        ImageId: CHANGEME # Optional
        InstanceInitiatedShutdownBehavior: CHANGEME # Optional
        InstanceMarketOptions: # Optional
          MarketType: CHANGEME # Optional
          SpotOptions: # Optional
            BlockDurationMinutes: 0 # Optional
            InstanceInterruptionBehavior: CHANGEME # Optional
            MaxPrice: CHANGEME # Optional
            SpotInstanceType: CHANGEME # Optional
            ValidUntil: CHANGEME # Optional
        InstanceType: CHANGEME # Optional
        KernelId: CHANGEME # Optional
        KeyName: CHANGEME # Optional
        LicenseSpecifications: # Optional
          - LicenseConfigurationArn: CHANGEME # Optional
        MetadataOptions: # Optional
          HttpEndpoint: CHANGEME # Optional
          HttpPutResponseHopLimit: 0 # Optional
          HttpTokens: CHANGEME # Optional
        Monitoring:
          Enabled: true
        NetworkInterfaces: # Optional
          - AssociateCarrierIpAddress: false # Optional
            AssociatePublicIpAddress: false # Optional
            DeleteOnTermination: false # Optional
            Description: CHANGEME # Optional
            DeviceIndex: 0 # Optional
            Groups: # Optional
              - CHANGEME
            InterfaceType: CHANGEME # Optional
            Ipv6AddressCount: 0 # Optional
            Ipv6Addresses: # Optional
              - Ipv6Address: CHANGEME # Optional
            NetworkCardIndex: 0 # Optional
            NetworkInterfaceId: CHANGEME # Optional
            PrivateIpAddress: CHANGEME # Optional
            PrivateIpAddresses: # Optional
              - Primary: false # Optional
                PrivateIpAddress: CHANGEME # Optional
            SecondaryPrivateIpAddressCount: 0 # Optional
            SubnetId: CHANGEME # Optional
        Placement: # Optional
          Affinity: CHANGEME # Optional
          AvailabilityZone: CHANGEME # Optional
          GroupName: CHANGEME # Optional
          HostId: CHANGEME # Optional
          HostResourceGroupArn: CHANGEME # Optional
          PartitionNumber: 0 # Optional
          SpreadDomain: CHANGEME # Optional
          Tenancy: CHANGEME # Optional
        RamDiskId: CHANGEME # Optional
        SecurityGroupIds: # Optional
          - CHANGEME
        SecurityGroups: # Optional
          - CHANGEME
        TagSpecifications: # Optional
          - ResourceType: CHANGEME # Optional
            Tags: # Optional
              - Key: CHANGEME
                Value: CHANGEME
        UserData: CHANGEME # Optional
      LaunchTemplateName: 
      TagSpecifications:
        - ResourceType: CHANGEME # Optional
          Tags: # Optional
            - Key: CHANGEME
              Value: CHANGEME

Outputs:
  EC2Instance:
    Value: !Ref EC2Instance
    Export:
      Name: EC2Instance


