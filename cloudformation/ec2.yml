AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parameters:
  Name:
    Type: String
    Default: nobody
    Description: 'Enter Your Name. (Exam: d-ito)'
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: The EC2 Key Pair to allow SSH access to the instance
  InstanceType:
    Type: String
    AllowedValues: [t2.micro, t3.micro]
    Description: Enter t2.micro or t3.micro
  AMIID:
    Type: String
    Default: ami-032d6db78f84e8bf5

Resources:
  EC2InstanceRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      Path: "/"

  EnableAccessS3Policy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: EC2AccessPolicies
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: "s3:*"
          Resource:
            - "arn:aws:s3:::*"
      Roles:
      - !Ref EC2InstanceRole

  EnableAccessCloudWatchPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: EC2AccessPolicies
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: "cloudwatch:*"
          Resource:
            - "arn:aws:cloudwatch:::*"
      Roles:
      - !Ref EC2InstanceRole

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: EC2InstanceProfile
      Roles:
        - !Ref EC2InstanceRole

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref AMIID
      KeyName: !Ref KeyName
      InstanceType: !Ref InstanceType
      EC2InstanceProfile: !Ref EC2InstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !ImportValue PublicSubnet
          GroupSet:
            - !ImportValue WebSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            DeleteOnTermination: true
            Encrypted: false
            VolumeSize: 8
            VolumeType: gp2
      UserData: !Base64 |
        #!/bin/bash
        sudo yum install -y git nginx amazon-cloudwatch-agent
      Tags:
        - Key: Name
          Value: ec2-tmp

  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: WebTemplate
      LaunchTemplateData:
        ImageId: ami-03d79d440297083e3
        InstanceType: t2.micro
        KeyName: !Ref KeyName
        SecurityGroupIds:
        CpuOptions:
          CoreCount: 1
          ThreadsPerCore: 2
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
          Name: EC2InstanceProfile
        Monitoring:
          Enabled: true
        NetworkInterfaces:
          - InterfaceType: interface
            AssociatePublicIpAddress: true
            DeleteOnTermination: true
            SubnetId: !ImportValue PublicSubnet
            Groups:
              - !ImportValue WebSecurityGroup
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              DeleteOnTermination: true
              Encrypted: true
              VolumeSize: 8
              VolumeType: gp2
        UserData:
          sudo yum -y install git nginx amazon-cloudwatch-agent
        InstanceInitiatedShutdownBehavior: stop
      TagSpecifications:
        - ResourceType: instance
          Tags:
            - Key: Name
              Value: !Sub ${Env}-web

  MyAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: CHANGEME # Optional
      AvailabilityZones:
        - CHANGEME
      CapacityRebalance: false # Optional
      Cooldown: CHANGEME # Optional
      DesiredCapacity: CHANGEME # Optional
      HealthCheckGracePeriod: 0 # Optional
      HealthCheckType: CHANGEME # Optional
      InstanceId: CHANGEME # Optional
      LaunchConfigurationName: CHANGEME # Optional
      LaunchTemplate: # Optional
        LaunchTemplateId: CHANGEME # Optional
        LaunchTemplateName: CHANGEME # Optional
        Version: CHANGEME
      LifecycleHookSpecificationList:
        - DefaultResult: CHANGEME # Optional
          HeartbeatTimeout: 0 # Optional
          LifecycleHookName: CHANGEME
          LifecycleTransition: CHANGEME
          NotificationMetadata: CHANGEME # Optional
          NotificationTargetARN: CHANGEME # Optional
          RoleARN: CHANGEME # Optional
      LoadBalancerNames:
        - CHANGEME
      MaxInstanceLifetime: 0 # Optional
      MaxSize: CHANGEME
      MetricsCollection:
        - Granularity: CHANGEME
          Metrics: # Optional
            - CHANGEME
      MinSize: CHANGEME
      MixedInstancesPolicy: # Optional
        InstancesDistribution: # Optional
          OnDemandAllocationStrategy: CHANGEME # Optional
          OnDemandBaseCapacity: 0 # Optional
          OnDemandPercentageAboveBaseCapacity: 0 # Optional
          SpotAllocationStrategy: CHANGEME # Optional
          SpotInstancePools: 0 # Optional
          SpotMaxPrice: CHANGEME # Optional
        LaunchTemplate:
          LaunchTemplateSpecification:
            LaunchTemplateId: CHANGEME # Optional
            LaunchTemplateName: CHANGEME # Optional
            Version: CHANGEME
          Overrides: # Optional
            - InstanceType: CHANGEME # Optional
              LaunchTemplateSpecification: # Optional
                LaunchTemplateId: CHANGEME # Optional
                LaunchTemplateName: CHANGEME # Optional
                Version: CHANGEME
              WeightedCapacity: CHANGEME # Optional
      NewInstancesProtectedFromScaleIn: false # Optional
      NotificationConfigurations:
        - NotificationTypes: # Optional
            - CHANGEME
          TopicARN: CHANGEME
      PlacementGroup: CHANGEME # Optional
      ServiceLinkedRoleARN: CHANGEME # Optional
      Tags:
        - Key: CHANGEME
          PropagateAtLaunch: false
          Value: CHANGEME
      TargetGroupARNs:
        - CHANGEME
      TerminationPolicies:
        - CHANGEME
      VPCZoneIdentifier:
        - CHANGEME

Outputs:
  EC2Instance:
    Value: !Ref EC2Instance
    Export:
      Name: EC2Instance

