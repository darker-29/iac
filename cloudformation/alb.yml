AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parameters:
  Env:
    Type: String
    Default: test

Resources:
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ALB Security Group
      GroupName: !Sub ${Env}-alb-secgroup
      VpcId:
        Fn::ImportValue:
          !Sub ${Env}-VpcId
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          FromPort: 80
          ToPort: 80
          IpProtocol: tcp
        - CidrIp: 0.0.0.0/0
          FromPort: 443
          ToPort: 443
          IpProtocol: tcp
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          FromPort: 80
          ToPort: 80
          IpProtocol: tcp
        - CidrIp: 0.0.0.0/0
          FromPort: 443
          ToPort: 443
          IpProtocol: tcp
      Tags:
        - Key: Name
          Value: !Sub ${Env}-alb-secgroup

  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${Env}-alb
      Type: application
      IpAddressType: dualstack
      Scheme: internet-facing
      Subnets:
        - Fn::ImportValue
          !Sub ${Env}-PublicSubnet1a
        - Fn::ImportValue
          !Sub ${Env}-PublicSubnet1c
      SecurityGroups:
        - !Ref ALBSecurityGroup
      LoadBalancerAttributes:
        - Key: deletion_protection
          Value: false
        - Key: access_logs.s3.enabled
          Value: true
        - Key: access_logs.s3.bucket
          Value: alb-logging
        - Key: access_logs.s3.prefix
          Value: !Sub ${Env}-
        - Key: idle_timeout.timeout_seconds
          Value: 60
        - Key: routing.http.desync_mitigation_mode
          Value: defensive
        - Key: routing.http.drop_invalid_header_fields.enabled
          Value: false
        - Key: routing.http.x_amzn_tls_version_and_cipher_suite.enabled
          Value: false
        - Key: routing.http.xff_client_port.enabled
          Value: false
        - Key: routing.http2.enabled
          Value: false
        - Key: waf.fail_open.enabled
          Value: false
      Tags:
        - Key: Name
          Value: !Sub ${Env}-alb
  
  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${Env}-targetgroup
      VpcId:
        Fn::ImportValue:
          !Sub ${Env}-VpcId
      Port: 443
      Protocol: HTTPS
      ProtocolVersion: HTTP2
      TargetType: alb
      Targets:
        - Id: !Ref LoadBalancer
          Port: 443
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: true
        - Key: stickiness.type
          Value: app_cookie
        - Key: stickiness.app_cookie.cookie_name
          Value: ALB_COOKIE
        - Key: stickiness.app_cookie.duration_seconds
          Value: 604800
        - Key: load_balancing.algorithm.type
          Value: round_robin
        - Key: slow_start.duration_seconds
          Value: 0
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 60
      HealthCheckPath: /healthcheck
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthCheckTimeoutSeconds: 30
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 5
      Tags:
        - Key: Name
          Value: !Sub ${Env}-targetgroup
  
  ALBListener80:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Protocol: HTTP
      Port: 80
      DefaultActions:
        - Order: 1
          Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: 443
            Host: '#{host}'
            Path: '/#{path}'
            Query: '#{query}'
            StatusCode: 'HTTP_301'
  
  ALBListener80MaintainanceModeRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ALBListener80
      Actions:
        - Order: 2
          Type: fixed-response
          FixedResponseConfig:
            StatusCode: 503
            ContentType: text/html
            MessageBody: | 
              Fn::Base64:
                CHANGEME
      Priority: 2

Outputs:
  ALBTargetGroup:
    Value: !Ref ALBTargetGroup
    Export:
      Name: !Sub ${Env}-ALBTargetGroup
