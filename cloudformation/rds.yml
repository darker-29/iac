AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parameters:

Mappings:

Conditions:

Resources:
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: DB Security Group
      GroupName: !Sub ${Env}-db-secgroup
      VpcId:
        Fn::ImportValue:
          !Sub ${Env}-VpcId
      SecurityGroupIngress:
        - SourceSecurityGroupId:
            Fn:importValue:
              !Sub ${Env}-WebSecurityGroup
          FromPort: 5432
          IpProtocol: tcp
          ToPort: 5432
      Tags:
        - Key: Name
          Value: !Sub ${Env}-db-secgroup

  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AvailabilityZone: ap-northeast-1a
      MultiAZ: false
      DBInstanceClass: db.t3.micro
      DBInstanceIdentifier: !Ref Env
      Engine: postgres
      EngineVersion: 13.5
      MasterUserPassword: testpass
      MasterUsername: testuser
      DBName: test
      Port: 5432
      StorageType: standard
      AllocatedStorage: 20
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      DBParameterGroupName: !Ref DBParameterGroup
        #OptionGroupName: !Ref OptionGroup
      AllowMajorVersionUpgrade: false
      AutoMinorVersionUpgrade: true
      PubliclyAccessible: false
      StorageEncrypted: false
      BackupRetentionPeriod: 30
      CopyTagsToSnapshot: false
      DeleteAutomatedBackups: true
      DeletionProtection: false
      EnableIAMDatabaseAuthentication: false
      EnablePerformanceInsights: false
      Tags:
        - Key: Name
          Value: !Sub ${Env}-db
        # EnableCloudwatchLogsExports:
        #   - CHANGEME
        # PerformanceInsightsRetentionPeriod: 0 # Optional
        # PerformanceInsightsKMSKeyId: CHANGEME # Optional
        # MonitoringInterval: 0 # Optional
        # MonitoringRoleArn: CHANGEME # Optional

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub ${Env}-dbsubnet
      DBSubnetGroupDescription: test subnet group
      SubnetIds:
        - Fn::importValue
          !Sub ${Env}-PrivateSubnet1a
        - Fn::importValue
          !Sub ${Env}-PrivateSubnet1c

  DBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: test db parametergroup
      Family: postgres13
        #Parameters:
        #  CHANGEME:
      Tags:
        - Key: Name
          Value: !Sub ${Env}-db

Outputs:
