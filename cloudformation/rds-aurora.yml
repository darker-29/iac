AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Parameters:
  Env:
    Type: String
    Default: test

Resources:
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: DB Security Group
      GroupName: !Sub ${Env}-db-secgroup
      VpcId:
        Fn::ImportValue:
          !Sub ${Env}-VpcId
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          FromPort: 5432
          IpProtocol: tcp
          ToPort: 5432
      Tags:
        - Key: Name
          Value: !Sub ${Env}-db-secgroup

  DBCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: !Sub ${Env}-db-cluster
      Engine: aurora-postgresql
      EngineMode: provisioned
      EngineVersion: 13.4
      DBClusterParameterGroupName: !Ref DBClusterParameterGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      DatabaseName: test
      MasterUsername: testuser
      MasterUserPassword: testpass
      Port: 5432
      StorageEncrypted: false
      VpcSecurityGroupIds:
        - !GetAtt DBSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: !Sub ${Env}-db-cluster

  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: db.t3.micro
      DBEngine: aurora-postgresql
      DBClusterIdentifier: !Ref DBCluster
      DBSubnetGroupName: !Ref DBSubnetGroup
      DBParameterGroupName: !Ref DBInstanceParameterGroup
      Tags:
        - Key: Name
          Value: !Sub ${Env}-db

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub ${Env}-dbsubnet
      DBSubnetGroupDescription: test subnet group
      SubnetIds:
        - Fn::ImportValue:
            !Sub ${Env}-PrivateSubnet1a
        - Fn::ImportValue:
            !Sub ${Env}-PrivateSubnet1c

  DBInstanceParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: test db parametergroup
      Family: postgres13
        #Parameters:
        #  CHANGEME:
      Tags:
        - Key: Name
          Value: !Sub ${Env}-db

  DBClusterParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      Description: test db cluster parametergroup
      Family: aurora-postgresql13
      Parameters:
        rds.force_ssl: true
      Tags:
        - Key: Name
          Value: !Sub ${Env}-cluster-parametergroup

